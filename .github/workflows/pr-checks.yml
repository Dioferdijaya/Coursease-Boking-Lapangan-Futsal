# Pull Request CI/CD Pipeline

name: PR Checks

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
      
      - name: Validate PR title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: $PR_TITLE"
          
          # Check if PR title follows convention (feat:, fix:, docs:, etc.)
          if [[ ! "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|test|chore|perf):\ .+ ]]; then
            echo "❌ PR title must follow conventional commits format"
            echo "Examples: feat: add chat feature, fix: resolve socket connection"
            exit 1
          fi
          echo "✅ PR title format is valid"
      
      - name: Check for merge conflicts
        run: |
          git fetch origin ${{ github.base_ref }}
          if git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) HEAD origin/${{ github.base_ref }} | grep -q '<<<<<'; then
            echo "❌ Merge conflicts detected!"
            exit 1
          fi
          echo "✅ No merge conflicts"
      
      - name: Backend - Install & Test
        working-directory: ./backend
        run: |
          npm ci
          echo "✅ Backend dependencies installed"
      
      - name: Frontend - Install, Test & Build
        working-directory: ./booking-frontend
        run: |
          npm ci
          npm test -- --passWithNoTests
          npm run build
        env:
          CI: false
      
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ All CI checks passed! Ready for review.'
            })
